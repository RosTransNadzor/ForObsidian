[[Auth]]

- Для сложных политик используются требования
	- 1) Создать требование
	- 2) Создать обработчик и привязать к требованию

- Одна политика может содержать несколько требований
1)
```cs
//требование это просто маркер для обработчик,но также может содержать дополнительные статические данные
public class IsAllowedToManageProductRequirement : IAuthorizationRequirement
{
}
```
2)
```cs
// реализация интерфейса обработчика(в обобщении указать тип требования)
public class IsEmployeeHandler : AuthorizationHandler<IsAllowedToManageProductRequirement>
{
	// принимает context - содержит User и требование
	protected override Task HandleRequirementAsync(
		AuthorizationHandlerContext context,
		IsAllowedToManageProductRequirement requirement)
	{
	   if (context.User.HasClaim(f => f.Type == "Employee"))
       {
         // удача в авторизации - отправить требование
         context.Succeed(requirement);
       }
       // означает неудача в авторизации
            return Task.CompletedTask;
    }
}
```
- Регистрация обработчика - можно с любым циклом жизни (обычно singleton)
```cs
services.AddSingleton<IAuthorizationHandler, MyHandler1>();
```
- Создание политики
```cs
// в данном случае политика содержит 2 требования
services.AddAuthorization(options =>
{
    options.AddPolicy("canManageProduct",
        policyBuilder =>
            policyBuilder.AddRequirements(
	            // требования указывают на обработчики
                new IsAccountEnabledRequirement(),
                new IsAllowedToManageProductRequirement()
	        )
	  );
});
```
- Использование политики происходит как обычно
```cs
[Authorize(Policy = "canManageProduct")]
public class MVCProductsController : Controller
```
