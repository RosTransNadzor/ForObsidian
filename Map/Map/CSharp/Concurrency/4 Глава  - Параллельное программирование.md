[[Конкурентность]]

- Остановка Parallel
	- Учтите, что цикл является параллельным, поэтому могут уже выполняться другие вызовы тела цикла, включая вызовы для элементов, следующих после текущего
	- Можно использовать метод стоп
		```cs
		Parallel.ForEach(matrices, (matrix, state) =>
		 { 
			 if (!matrix.IsInvertible) 
				 state.Stop(); 
			 else matrix.Invert(); 
		});
		```
- Отмена Parallel
	- Будут полностью завершены уже запущенные задачи,но новые не будут запускаться, после завершения последней будет выдано OperationCancelledException
	- С помощью передачи CancellationToken в ParallelOptions 
		```cs
		CancellationTokenSource cts = new();  
		cts.CancelAfter(100);  
		  
		ParallelOptions options = new ParallelOptions  
		{  
		    CancellationToken = cts.Token,  
		    MaxDegreeOfParallelism = 3  
		};  
		try  
		{  
		    Parallel.For(0, 10,options,(num, state) =>  
		    {  
		        Console.WriteLine($"started with num {num}");  
		        Task.Delay(num * 1000).Wait();  
		        Console.WriteLine($"completed with num {num}");  
		    });
		}  
		catch (OperationCanceledException ex)  
		{  
		    Console.WriteLine(ex.Message);  
		}
		```
- Аггрегация в Parallel.For и Parallel.ForEach
	- localInit - вызывается один раз для каждой итерации,и передается 3м параметром в body
	- Делегат `localFinally` вызывается один раз для каждой задачи для выполнения окончательного действия в локальном состоянии каждой задачи. Этот делегат может вызываться одновременно для нескольких задач; Поэтому необходимо синхронизировать доступ ко всем общим переменным.
	```cs
	Parallel.ForEach(source: values, 
		localInit: () => 0, 
		body: (item, state, localValue) => localValue + item, 
		localFinally: localValue => { lock (mutex) result += localValue; });
	```
- PLINQ
	- Parallel LINQ (PLINQ) расширяет поддержку LINQ параллельной обработкой.
	- Обработка данных с PLINQ 
		```cs
		IEnumerable MultiplyBy2(IEnumerable values) {
			// AsParallel - выполняет параллельно
			// AsOrdred - сохранение оригинального порядка последовательности 
			return values.AsParallel().AsOrdered().Select(value => value * 2); 
		}
		```

